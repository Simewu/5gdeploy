# 5gdeploy/trafficgen

Package **trafficgen** integrates a number of subcommands into the `compose.sh` script generated by [netdef-compose](../netdef-compose/README.md) command that prints traffic flow information or runs traffic generators.
They can be invoked in a Compose context directory (e.g. `~/compose/20230601`), after the UEs have been registered and the PDU sessions have been established.

## Gather netif counters

`./compose.sh linkstat` command prints a table or writes a TSV document that lists network interface counters.
The information is gathered by executing `ip -s link show` in each container's network namespace, either through the bridge container on a multi-host deployment or in the target container itself.
If NIC queue counters are requested, it is gathered through `ethtool -S` command.

By default, the output is an aligned textual table.
You can set `--out=FILENAME` flag to write to a TSV output file.
You can set `--out=-.tsv` flag to print the TSV document to the console.

The table shows network interfaces within each container (across all hosts, in case of a multi-host deployment).
Each row has container name, network interface name, NIC queue number, RX packet counter, and TX packet counter.
The sort order may be changed with either `--sort-by=ct` or `--sort-by=net` flag.

By default, the table includes all services defined in the Compose file that have their own network namespaces and all network interfaces in these services, but excludes NIC queue counters.
You can specify `--link='CT-PATTERN | NET-PATTERN | OPTS'` (repeatable) to change what's included:

* *CT-PATTERN* is either:
  * a minimatch pattern that matches the container name;
  * "host:" followed by a host IP address, to gather information from a host machine;
  * "host-of:" followed by a minimatch pattern that matches the container name, to gather information from the host machines running these containers.
* *NET-PATTERN* is a minimatch pattern that matches the network interface name.
* *OPTS* (optional) may contain:
  * "#eth" requests NIC queue counters, supported on PCI Ethernet adapters only.

Each packet counter is an accumulative value since the network interface was added.
Typically, you should run this command once before starting traffic generators, and again after stopping traffic generators, and then calculate the difference between the two counter readings on the same network interface.
Depending on the scenario topology and traffic flows you executed, it may be possible to determine whether the traffic flows were sent over the expected network interfaces, and whether packet loss has occurred either within a network function or on the network links between two network functions.

```bash
./compose.sh linkstat --link='gnb*|n3' --link='upf*|n[36]|#eth' --link='dn_*|n6' --out=linkstat0.tsv
./tg.sh
./compose.sh linkstat --link='gnb*|n3' --link='upf*|n[36]|#eth' --link='dn_*|n6' --out=linkstat1.tsv
paste linkstat0.tsv linkstat1.tsv | awk '
  NR==1 { NF=5; print }
  $1==$6 && $2==$7 && $3==$8 { print $1, $2, $3, $9-$4, $10-$5 }
' | column -t
```

## List PDU sessions

`./compose.sh list-pdu` command prints a table or writes a TSV document that lists all established PDU sessions.
You can choose an output format with the `--out` flag, same as the `linkstat` subcommand section.

The information is gathered by executing `ip addr show` in each UE container, and then matching the interface IP addresses against UE subnets defined for Data Networks.
Any network interface that has an IP address within one of the UE subnets is considered a PDU session and included in the output.

If a UE container runs multiple UEs, it's necessary to identify which UE owns each IP address for an accurate report.
For UERANSIM, the `nr-cli ps-list` command output is taken into consideration.
For PacketRusher, the network interface name is taken into consideration.
Other than the above UE implementations, if there are multiple network interfaces matching the DN subnet, the report could be imprecise.

## nmap

`./compose.sh nmap` performs nmap ping scans from Data Network to determine how many UEs are reachable.
`--dnn` flag, specified as a [minimatch](https://www.npmjs.com/package/minimatch) pattern, selects which Data Network(s) to scan.
The scanned subnet size for each Data Network is adjusted to cover all online UEs.
`--cmdout` flag saves the commands to a file instead of executing.

```bash
# scan all Data Networks
./compose.sh nmap

# scan specific Data Networks
./compose.sh nmap --dnn='internet'

# print commands instead of executing
./compose.sh nmap --cmdout=-.sh

# save commands to file instead of executing
./compose.sh nmap --cmdout=nmap.sh
```

## Client-Server Traffic Generators

See [client-server traffic generators](../docs/tgcs.md) for how to use iperf3, OWAMP, etc.

## ns-3 Traffic Generators

See [ns-3 traffic generators](../docs/ns3.md).

## Named Data Networking

See [Named Data Networking in user plane](../docs/NDN.md).
